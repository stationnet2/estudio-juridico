{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">Caso #{{ caso.id }}</h1>
    <div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">‚Üê Volver al Panel</a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Informaci√≥n del Cliente -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìã Informaci√≥n del Cliente</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nombre:</strong> {{ caso.nombre or 'No especificado' }}</p>
                        <p><strong>Email:</strong> 
                            <a href="mailto:{{ caso.email }}">{{ caso.email or 'No especificado' }}</a>
                        </p>
                        <p><strong>Tel√©fono:</strong> 
                            <a href="tel:{{ caso.telefono }}">{{ caso.telefono or 'No especificado' }}</a>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Fecha de creaci√≥n:</strong> {{ caso.fecha_creacion or 'N/A' }}</p>
                        <p><strong>Estado actual:</strong> 
                            <span class="badge {{ obtener_color_estado(caso.estado or 'nuevo') }}">
                                {{ caso.estado or 'nuevo' }}
                            </span>
                        </p>
                        <p><strong>Prioridad:</strong> 
                            {% set prioridad = caso.prioridad or 1 %}
                            {% if prioridad == 5 %}
                            <span class="badge bg-danger">M√°xima</span>
                            {% elif prioridad == 4 %}
                            <span class="badge bg-warning">Alta</span>
                            {% elif prioridad == 3 %}
                            <span class="badge bg-info">Media</span>
                            {% elif prioridad == 2 %}
                            <span class="badge bg-secondary">Baja</span>
                            {% else %}
                            <span class="badge bg-light text-dark">M√≠nima</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n del Accidente -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">üöó Informaci√≥n del Accidente</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Tipo de accidente:</strong> 
                            {% if caso.tipo_accidente == 'vehicular' %}üöó Vehicular
                            {% elif caso.tipo_accidente == 'peatonal' %}üö∂ Peatonal
                            {% elif caso.tipo_accidente == 'motocicleta' %}üèçÔ∏è Motocicleta
                            {% elif caso.tipo_accidente == 'publico' %}üöå Transporte P√∫blico
                            {% else %}No especificado{% endif %}
                        </p>
                        <p><strong>Rol del cliente:</strong> 
                            {% if caso.rol_usuario == 'victima' %}üë§ V√≠ctima/Afectado
                            {% elif caso.rol_usuario == 'responsable' %}üö¶ Causante/Responsable
                            {% else %}No especificado{% endif %}
                        </p>
                        <p><strong>Fecha del accidente:</strong> {{ caso.fecha_accidente or 'No indicada' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Lesiones personales:</strong> 
                            <span class="badge {{ 'bg-danger' if caso.hay_lesiones == 'on' else 'bg-secondary' }}">
                                {{ 'S√ç' if caso.hay_lesiones == 'on' else 'NO' }}
                            </span>
                        </p>
                        <p><strong>Da√±os materiales:</strong> 
                            <span class="badge {{ 'bg-warning' if caso.hay_danos_materiales == 'on' else 'bg-secondary' }}">
                                {{ 'S√ç' if caso.hay_danos_materiales == 'on' else 'NO' }}
                            </span>
                        </p>
                        <p><strong>Seguros involucrados:</strong> 
                            <span class="badge {{ 'bg-success' if caso.tiene_seguro == 'on' else 'bg-secondary' }}">
                                {{ 'S√ç' if caso.tiene_seguro == 'on' else 'NO' }}
                            </span>
                        </p>
                    </div>
                </div>
                
                {% if caso.seguro_propio or caso.seguro_contrario %}
                <div class="mt-3 p-3 bg-light rounded">
                    <h6>üè¢ Informaci√≥n de Seguros:</h6>
                    <p><strong>Seguro propio:</strong> {{ caso.seguro_propio or 'No especificado' }}</p>
                    <p><strong>Seguro contrario:</strong> {{ caso.seguro_contrario or 'No especificado' }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Descripci√≥n del Accidente -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üìù Descripci√≥n del Accidente</h5>
            </div>
            <div class="card-body">
                <div class="bg-light p-3 rounded">
                    <p style="white-space: pre-wrap; line-height: 1.6;">
                        {{ caso.descripcion or 'Sin descripci√≥n disponible.' }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Evaluaci√≥n del Caso -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">‚ö° Evaluaci√≥n del Caso</h5>
            </div>
            <div class="card-body">
                {% set punt = caso.puntuacion_viabilidad or 0 %}

                <div class="mb-3">
                    <label class="form-label fw-bold">Puntuaci√≥n de viabilidad:</label>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar {{ obtener_color_puntuacion(punt) }}" 
                             style="width: {{ punt * 10 }}%">
                            <strong>{{ punt }}/10</strong>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Estado del caso:</label>
                    <div>
                        <span class="badge {{ obtener_color_estado(caso.estado or 'nuevo') }} mb-2" style="font-size: 1em;">
                            {{ (caso.estado or 'nuevo')|upper }}
                        </span>
                    </div>
                </div>

                <div class="alert alert-info">
                    <small>
                        <strong>Evaluaci√≥n autom√°tica:</strong><br>
                        {% if punt >= 8 %}
                        ‚úÖ <strong>Caso de alta viabilidad</strong><br>Recomendado para seguimiento inmediato
                        {% elif punt >= 5 %}
                        ‚ö†Ô∏è <strong>Caso de viabilidad media</strong><br>Requiere revisi√≥n detallada
                        {% else %}
                        ‚ùå <strong>Caso de baja viabilidad</strong><br>Posible descarte
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">üéØ Acciones R√°pidas</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="tel:{{ caso.telefono }}" class="btn btn-success btn-sm">
                        üìû Llamar al cliente
                    </a>
                    <a href="https://wa.me/549{{ (caso.telefono or '')|replace(' ', '')|replace('+', '')|replace('-', '') }}?text=Hola {{ caso.nombre or '' }}, soy del estudio jur√≠dico. Vi su consulta sobre el accidente y me gustar√≠a ayudarle." 
                       target="_blank" 
                       class="btn btn-success btn-sm">
                        üì± WhatsApp al cliente
                    </a>
                    <a href="mailto:{{ caso.email }}?subject=Estudio Jur√≠dico - Consulta sobre accidente&body=Hola {{ caso.nombre or '' }},%0D%0A%0D%0AHe revisado su consulta sobre el accidente y me gustar√≠a programar una reuni√≥n para evaluar su caso.%0D%0A%0D%0ASaludos cordiales" 
                       class="btn btn-primary btn-sm">
                        ‚úâÔ∏è Enviar email
                    </a>
                </div>

                <!-- Formulario de actualizaci√≥n -->
                <form method="POST" action="/admin/actualizar-caso/{{ caso.id }}" class="mt-3">
                    <div class="mb-2">
                        <label class="form-label fw-bold">Actualizar estado:</label>
                        <select name="estado" class="form-select form-select-sm">
                            {% set est = caso.estado or 'nuevo' %}
                            <option value="nuevo" {{ 'selected' if est == 'nuevo' }}>Nuevo</option>
                            <option value="en_revision" {{ 'selected' if est == 'en_revision' }}>En Revisi√≥n</option>
                            <option value="apto" {{ 'selected' if est == 'apto' }}>Apto</option>
                            <option value="descartado" {{ 'selected' if est == 'descartado' }}>Descartado</option>
                            <option value="contactado" {{ 'selected' if est == 'contactado' }}>Contactado</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-bold">Prioridad:</label>
                        {% set pr = caso.prioridad or 1 %}
                        <select name="prioridad" class="form-select form-select-sm">
                            <option value="1" {{ 'selected' if pr == 1 }}>M√≠nima</option>
                            <option value="2" {{ 'selected' if pr == 2 }}>Baja</option>
                            <option value="3" {{ 'selected' if pr == 3 }}>Media</option>
                            <option value="4" {{ 'selected' if pr == 4 }}>Alta</option>
                            <option value="5" {{ 'selected' if pr == 5 }}>M√°xima</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-bold">Observaciones:</label>
                        <textarea name="observaciones" class="form-control form-control-sm" rows="3" 
                                  placeholder="Agregar observaciones del abogado...">{{ caso.observaciones_abogado or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-warning btn-sm w-100">üíæ Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
